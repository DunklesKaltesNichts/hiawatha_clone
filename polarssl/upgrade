#!/bin/sh

cd `dirname $0`

if [ "$1" = "" ]; then
	echo "Usage: ${0} <version>"
	exit
fi

echo "Downloading PolarSSL version ${1}."
wget --no-check-certificate -qO polarssl.tgz "https://polarssl.org/download/polarssl-${1}-gpl.tgz?do=yes"

if [ ! -s polarssl.tgz ]; then 
	rm -f polarssl.tgz
	echo "Download error."
	exit
fi

echo "Removing current PolarSSL library."
rm -rf include
rm -rf library

echo "Installing new PolarSSL library."
tar -xzf polarssl.tgz
dir=`tar -tzf polarssl.tgz | head -n1`
mv ${dir}ChangeLog .
mv ${dir}include .
mv ${dir}library .

if [ -f patches/${1}.diff ]; then
	echo "Applying patch."
	patch -p1 < patches/${1}.diff
fi

echo "Cleaning up."
rm -f include/.gitignore
rm -f library/.gitignore
rm -rf ${dir}
rm polarssl.tgz

echo "PolarSSL upgraded to version ${1}."
